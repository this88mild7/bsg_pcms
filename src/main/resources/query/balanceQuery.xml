<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="balanceQuery">
   
   <!-- INSERT -->
   <insert id="createSaleCompany" useGeneratedKeys="true" keyProperty="balance_mgmtno">
		INSERT INTO BALANCE
			( 
				COMPANY_MGMTNO,
				USER_MGMTSEQ, 
				SALE_STR_DATE, 
				SALE_END_DATE, 
				SALE_COMMISSION, 
				CP_COMMISSION, 
				OWNER_PROFIT, 
				TOTAL_SALE_COUNT, 
				TOTAL_SALE_PRICE, 
				SALE_TYPE,
				CONTRACT_TYPE,
				MOD_DT, 
				REG_DT )
		VALUES
			( 
				#{company_mgmtno}, 
				#{user_mgmtseq}, 
				#{sale_str_date}, 
				#{sale_end_date}, 
				#{total_sale_company_commission}, 
				#{total_cp_commission}, 
				#{total_profit}, 
				#{total_sale_count}, 
				#{total_sale_price}, 
				#{sale_type}, 
				#{contract_type}, 
				NOW(), 
				NOW() 
			)
   </insert>
   
   <insert id="createDetail" parameterType="com.bsg.pcms.dto.BalanceDetailDTO">
		INSERT INTO BALANCE_DETAIL
			( 
				BALANCE_MGMTNO,
				CONTENTS_CD, 
				SALE_COUNT,
				SALE_PRICE,
				CP_PROFIT,
				SALE_PROFIT, 
				MOD_DT, 
				REG_DT )
		VALUES
			( 
				#{balance_mgmtno}, 
				#{contents_cd}, 
				#{sale_count}, 
				#{contentsSalePrice}, 
				#{contentsCpProfit}, 
				#{contentsSaleProfit}, 
				NOW(), 
				NOW() 
			)
   </insert>

   <!-- SELECT -->
   <!-- CP 정산 리스트 -->
	<select id="cpList" resultType="com.bsg.pcms.balance.dto.BalanceDTOEx">
		SELECT /* cpList */
			  DATE_FORMAT(BAL.SALE_STR_DATE,'%Y-%m-%d') as SALE_STR_DATE 
			, DATE_FORMAT(BAL.SALE_END_DATE,'%Y-%m-%d') as SALE_END_DATE
			, COM.COMPANY_NAME
			, SUM(BALD.SALE_PRICE * BALD.SALE_COUNT) AS TOTAL_SALE_PRICE
			, SUM(BALD.CP_PROFIT) AS CP_COMMISSION
			, (SELECT CD_DETAIL FROM CD WHERE CD =
				(SELECT CONTRACT_TYPE FROM CONTRACT WHERE CONTRACT_MGMTNO = CONT.CONTRACT_MGMTNO)
			  ) AS CONTRACT_TYPE
			, BAL.REG_DT
		FROM BALANCE BAL, COMPANY COM, BALANCE_DETAIL BALD, CONTENTS CD, CONTRACT CONT
		WHERE 1=1
		AND BAL.BALANCE_MGMTNO = BALD.BALANCE_MGMTNO
		AND BALD.CONTENTS_CD = CD.CONTENTS_CD
		AND CD.COMPANY_MGMTNO =  COM.COMPANY_MGMTNO
		AND COM.COMPANY_MGMTNO = CONT.COMPANY_MGMTNO
		AND COM.COMPANY_TYPE = 'CP'
		AND BAL.DEL_YN  = 'N'
		GROUP BY BAL.BALANCE_MGMTNO
		<!-- 등록순 -->
		<if test="sortingType == 1">
			ORDER BY BAL.BALANCE_MGMTNO 
		</if>
		<!-- 매출순 -->
		<if test="sortingType == 2">
			ORDER BY BAL.TOTAL_SALE_PRICE DESC
		</if>
		<!-- 수익순 -->
		<if test="sortingType == 3">
			ORDER BY BAL.OWNER_PROFIT DESC
		</if>
		<!-- 판매순 -->
		<if test="sortingType == 4">
			ORDER BY BAL.TOTAL_SALE_COUNT DESC
		</if>
	</select>
   <!-- CP 정산 조회 리스트 -->
	<select id="searchCP" resultType="com.bsg.pcms.balance.dto.BalanceDTOEx">
		SELECT 
			  DATE_FORMAT(BAL.SALE_STR_DATE,'%Y-%m-%d') as SALE_STR_DATE 
			, DATE_FORMAT(BAL.SALE_END_DATE,'%Y-%m-%d') as SALE_END_DATE
			, COM.COMPANY_NAME
			, SUM(BALD.SALE_PRICE * BALD.SALE_COUNT) AS TOTAL_SALE_PRICE
			, SUM(BALD.CP_PROFIT) AS CP_COMMISSION
			, BAL.REG_DT
		FROM BALANCE BAL, COMPANY COM, BALANCE_DETAIL BALD, CONTENTS CD
		WHERE 1=1
		AND BAL.BALANCE_MGMTNO = BALD.BALANCE_MGMTNO
		AND BALD.CONTENTS_CD = CD.CONTENTS_CD
		AND CD.COMPANY_MGMTNO =  COM.COMPANY_MGMTNO
		AND COM.COMPANY_TYPE = 'CP'
		AND BAL.DEL_YN  = 'N'
		<if test="searchQuery != null">
		AND COM.COMPANY_NAME like '%${searchQuery}%'
		</if>
		<if test="searchStrDate != null">
			<if test="searchEndDate != null">
			AND BAL.REG_DT 
				BETWEEN #{searchStrDate}  
				AND #{searchEndDate}
			</if>
		</if>
		GROUP BY BAL.BALANCE_MGMTNO
		<!-- 등록순 -->
		<if test="sortingType == 1">
			ORDER BY BAL.BALANCE_MGMTNO 
		</if>
		<!-- 매출순 -->
		<if test="sortingType == 2">
			ORDER BY BAL.TOTAL_SALE_PRICE DESC
		</if>
		<!-- 수익순 -->
		<if test="sortingType == 3">
			ORDER BY BAL.OWNER_PROFIT DESC
		</if>
		<!-- 판매순 -->
		<if test="sortingType == 4">
			ORDER BY BAL.TOTAL_SALE_COUNT DESC
		</if>
	</select>
	
	<!-- 판매 정산 리스트 -->
	<select id="saleList" parameterType="com.bsg.pcms.balance.dto.BalanceDTOEx" 
						resultType="com.bsg.pcms.balance.dto.BalanceDTOEx">
		SELECT /* Balance.saleList */ 
			(SELECT CD_DETAIL FROM CD WHERE CD = BAL.SALE_TYPE) AS SALE_TYPE, 
			(SELECT CD_DETAIL FROM CD WHERE CD = BAL.CONTRACT_TYPE) AS CONTRACT_TYPE, 
			BAL.SALE_STR_DATE, 
			BAL.SALE_END_DATE, 
			BAL.SALE_COMMISSION, 
			BAL.CP_COMMISSION, 
			BAL.OWNER_PROFIT, 
			BAL.TOTAL_SALE_COUNT, 
			BAL.TOTAL_SALE_PRICE, 
			COM.COMPANY_NAME, 
			CONCAT(CONT.NAME, ' 외 ', count(CONT.NAME)-1) AS contents_name				
		FROM BALANCE BAL, COMPANY COM, BALANCE_DETAIL BD, CONTENTS CONT			
		WHERE 1=1
		AND COM.COMPANY_MGMTNO = BAL.COMPANY_MGMTNO 
		AND BAL.BALANCE_MGMTNO = BD.BALANCE_MGMTNO 
		AND CONT.CONTENTS_CD = BD.CONTENTS_CD
		AND BAL.DEL_YN = 'N'
		AND COM.COMPANY_TYPE = 'SC'
		GROUP BY BAL.BALANCE_MGMTNO
		<!-- 등록순 -->
		<if test="sortingType == 1">
			ORDER BY BAL.BALANCE_MGMTNO 
		</if>
		<!-- 매출순 -->
		<if test="sortingType == 2">
			ORDER BY BAL.TOTAL_SALE_PRICE DESC
		</if>
		<!-- 수익순 -->
		<if test="sortingType == 3">
			ORDER BY BAL.OWNER_PROFIT DESC
		</if>
		<!-- 판매순 -->
		<if test="sortingType == 4">
			ORDER BY BAL.TOTAL_SALE_COUNT DESC
		</if>
			
	</select>
	
	<!-- 판매정산 조회 -->
	<select id="searchSale" resultType="com.bsg.pcms.balance.dto.BalanceDTOEx">
		SELECT /* Balance.searchByDate */ 
			BAL.*, COM.COMPANY_NAME, CON.CONTRACT_TYPE,
			CONCAT(CONT.NAME, ' 외 ', count(CONT.NAME)-1) AS contents_name,				
			CDT.SALE_TYPE
			FROM BALANCE BAL, COMPANY COM, CONTRACT CON, CONTRACT_DETAIL CDT, BALANCE_DETAIL BD,
			CONTENTS CONT
		WHERE 1=1
		AND COM.COMPANY_MGMTNO = BAL.COMPANY_MGMTNO 
		AND BAL.CONTRACT_MGMTNO = CON.CONTRACT_MGMTNO
		AND BAL.BALANCE_MGMTNO = BD.BALANCE_MGMTNO 
		AND CON.CONTRACT_MGMTNO = CDT.CONTRACT_MGMTNO 
		AND CONT.CONTENTS_CD = BD.CONTENTS_CD
		AND BAL.DEL_YN = 'N'
		AND COM.COMPANY_TYPE = 'SC'
		<if test="searchQuery != null">
		AND COM.COMPANY_NAME like '%${searchQuery}%'
		</if>
		<if test="searchStrDate != null">
			<if test="searchEndDate != null">
			AND BAL.REG_DT 
				BETWEEN #{searchStrDate}  
				AND #{searchEndDate}
			</if>
		</if>
		<!-- 등록순 -->
		<if test="sortingType == 1">
			ORDER BY BAL.BALANCE_MGMTNO 
		</if>
		<!-- 매출순 -->
		<if test="sortingType == 2">
			ORDER BY BAL.TOTAL_SALE_PRICE DESC
		</if>
		<!-- 수익순 -->
		<if test="sortingType == 3">
			ORDER BY BAL.OWNER_PROFIT DESC
		</if>
		<!-- 판매순 -->
		<if test="sortingType == 4">
			ORDER BY BAL.TOTAL_SALE_COUNT DESC
		</if>
	</select>
	
	
	<!-- 판매업체 리스티 -->
	<select id="saleCompanyList" resultType="java.util.Map">
		SELECT /* Balance.saleCompanyList */ 
			COM.COMPANY_NAME as company_name,
			COM.COMPANY_MGMTNO as company_mgmtno
		FROM COMPANY COM, CONTRACT CONT
		WHERE 1=1
		AND COM.COMPANY_MGMTNO = CONT.COMPANY_MGMTNO
		AND COM.COMPANY_TYPE = 'SC'
	</select>
	
	<!-- 판매업체 판매 디바이스 -->
	<select id="device" resultType="java.util.Map">
		SELECT /* Balance.device */ 
			CTD.SALE_TYPE as sale_type,
			(SELECT CD_DETAIL FROM CD WHERE CD = CTD.SALE_TYPE) AS sale_type_name
		FROM COMPANY COM, CONTRACT CONT, CONTRACT_DETAIL CTD
		WHERE 1=1
		AND COM.COMPANY_MGMTNO = CONT.COMPANY_MGMTNO
		AND CONT.CONTRACT_MGMTNO = CTD.CONTRACT_MGMTNO
		AND COM.COMPANY_TYPE = 'SC'
		AND COM.COMPANY_MGMTNO = #{company_mgmtno}
		GROUP BY CTD.SALE_TYPE
	</select>
	
	<!-- 판매방식 -->
	<select id="saleType" resultType="java.util.Map">
		SELECT /* Balance.saleType */ 
			CONT.CONTRACT_TYPE as contract_type,
			(SELECT CD_DETAIL FROM CD WHERE CD = CONT.CONTRACT_TYPE) AS contract_type_name
		FROM COMPANY COM, CONTRACT CONT
		WHERE 1=1
		AND COM.COMPANY_MGMTNO = CONT.COMPANY_MGMTNO
		AND COM.COMPANY_TYPE = 'SC'
		AND COM.COMPANY_MGMTNO = #{company_mgmtno}
		GROUP BY CONT.CONTRACT_TYPE
	</select>
	
	<!-- 정산 대상 컨텐츠 리스트 -->
	<select id="contents" resultType="Map">
		SELECT 
			CCGR.CONTENTS_CD as contents_cd, 
			CON.NAME as name, 
			CCGR.SALE_PRICE as sale_price, 
			(
				SELECT SALE_PROFIT_RATE FROM CONTRACT
				WHERE COMPANY_MGMTNO=CON.COMPANY_MGMTNO
				LIMIT 1
			) AS cp_rate,
			CNTR.SALE_PROFIT_RATE AS sale_company_rate,
			(SELECT COMPANY_NAME FROM COMPANY WHERE COMPANY_MGMTNO = CON.COMPANY_MGMTNO) AS cp_name
		
		FROM 
					COMPANY COM, CONTRACT CNTR, CONTENTS CON, 
				 	CONTRACT_CONTENTS_GROUP CCGR
		WHERE 1=1 
		AND COM.COMPANY_MGMTNO = CNTR.COMPANY_MGMTNO 
		AND CON.CONTENTS_CD =CCGR.CONTENTS_CD		
		AND CNTR.COMPANY_MGMTNO = #{company_mgmtno}
		AND CNTR.CONTRACT_TYPE = #{contract_type}
		GROUP BY CCGR.CONTENTS_CD
		
	</select>
	
	<!-- 
	<select id="detail" resultType="java.lanMap">
		SELECT BAL.*, COM.COMPANY_NAME FROM BALANCE BAL, COMPANY COM
		WHERE 1=1
		AND COM.COMPANY_MGMTNO = BAL.COMPANY_MGMTNO 
		AND BAL.BALANCE_MGMTNO =  #{balance_mgmtno} 
		AND BAL.DEL_YN = 'N'
	</select>
	 -->
   <!-- UPDATE -->
   
   <update id="modify">
		UPDATE BALANCE 
		SET
			SALE_STR_DATE = #{sale_str_date}, 
			SALE_END_DATE= #{sale_end_date}, 
			SALE_COMMISSION= #{sale_commission}, 
			CP_COMMISSION= #{cp_commission}, 
			OWNER_PROFIT= #{owner_profit}, 
			TOTAL_SALE_COUNT= #{total_sale_count}, 
			TOTAL_SALE_PRICE= #{total_sale_price}, 
			MOD_DT= NOW()
		WHERE BALANCE_MGMTNO = #{balance_mgmtno}
   </update>
   
   <update id="delete">
		UPDATE BALANCE 
		SET
			DEL_YN = 'Y', 
			MOD_DT= NOW()
		WHERE BALANCE_MGMTNO = #{balance_mgmtno}
   </update>

   <!-- DELETE -->
   
</mapper>
