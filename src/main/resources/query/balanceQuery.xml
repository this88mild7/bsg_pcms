<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="balanceQuery">
   
   <!-- INSERT -->
   <insert id="createSaleCompany" useGeneratedKeys="true" keyProperty="balance_mgmtno">
		INSERT INTO BALANCE
			( 
				COMPANY_MGMTNO,
				USER_MGMTSEQ, 
				SALE_STR_DATE, 
				SALE_END_DATE, 
				SALE_COMMISSION, 
				CP_COMMISSION, 
				OWNER_PROFIT, 
				TOTAL_SALE_COUNT, 
				TOTAL_SALE_PRICE, 
				CONTRACT_MGMTNO,
				MOD_DT, 
				REG_DT )
		VALUES
			( 
				#{company_mgmtno}, 
				#{user_mgmtseq}, 
				#{sale_str_date}, 
				#{sale_end_date}, 
				#{sale_commission}, 
				#{cp_commission}, 
				#{owner_profit}, 
				#{total_sale_count}, 
				#{total_sale_price}, 
				#{contract_mgmtno}, 
				NOW(), 
				NOW() 
			)
   </insert>
   
   <insert id="createDetail" parameterType="com.bsg.pcms.dto.BalanceDetailDTO">
		INSERT INTO BALANCE_DETAIL
			( 
				BALANCE_MGMTNO,
				CONTENTS_CD, 
				SALE_COUNT, 
				MOD_DT, 
				REG_DT )
		VALUES
			( 
				#{balance_mgmtno}, 
				#{contents_cd}, 
				#{sale_count}, 
				NOW(), 
				NOW() 
			)
   </insert>

   <!-- SELECT -->
   <!-- CP 정산 리스트 -->
	<select id="cpList" resultType="com.bsg.pcms.balance.dto.BalanceDTOEx">
		SELECT BAL.*, COM.COMPANY_NAME, CON.CONTRACT_TYPE
			FROM BALANCE BAL, COMPANY COM, CONTRACT CON 
		WHERE 1=1
		AND COM.COMPANY_MGMTNO = BAL.COMPANY_MGMTNO 
		AND BAL.CONTRACT_MGMTNO = CON.CONTRACT_MGMTNO
		AND BAL.DEL_YN = 'N'
		AND COM.COMPANY_TYPE = 'CP'
		AND BAL.REG_DT
			BETWEEN TIMESTAMP(CONCAT( DATE_FORMAT(NOW(), '%Y'), DATE_FORMAT(NOW(), '%m'), '01'))  
			AND TIMESTAMP(DATE_FORMAT(LAST_DAY((NOW())), '%Y-%m-%d 23:59:59'))
		<!-- 등록순 -->
		<if test="sortingType == 1">
			ORDER BY BAL.BALANCE_MGMTNO 
		</if>
		<!-- 매출순 -->
		<if test="sortingType == 2">
			ORDER BY BAL.TOTAL_SALE_PRICE DESC
		</if>
		<!-- 수익순 -->
		<if test="sortingType == 3">
			ORDER BY BAL.OWNER_PROFIT DESC
		</if>
		<!-- 판매순 -->
		<if test="sortingType == 4">
			ORDER BY BAL.TOTAL_SALE_COUNT DESC
		</if>
	</select>
   <!-- CP 정산 리스트 -->
	<select id="searchCP" resultType="com.bsg.pcms.balance.dto.BalanceDTOEx">
		SELECT BAL.*, COM.COMPANY_NAME, CON.CONTRACT_TYPE
			FROM BALANCE BAL, COMPANY COM, CONTRACT CON 
		WHERE 1=1
		AND COM.COMPANY_MGMTNO = BAL.COMPANY_MGMTNO 
		AND BAL.CONTRACT_MGMTNO = CON.CONTRACT_MGMTNO
		AND BAL.DEL_YN = 'N'
		AND COM.COMPANY_TYPE = 'CP'
		<if test="searchQuery != null">
		AND COM.COMPANY_NAME like '%${searchQuery}%'
		</if>
		<if test="searchStrDate != null">
			<if test="searchEndDate != null">
			AND BAL.REG_DT 
				BETWEEN #{searchStrDate}  
				AND #{searchEndDate}
			</if>
		</if>
		<!-- 등록순 -->
		<if test="sortingType == 1">
			ORDER BY BAL.BALANCE_MGMTNO 
		</if>
		<!-- 매출순 -->
		<if test="sortingType == 2">
			ORDER BY BAL.TOTAL_SALE_PRICE DESC
		</if>
		<!-- 수익순 -->
		<if test="sortingType == 3">
			ORDER BY BAL.OWNER_PROFIT DESC
		</if>
		<!-- 판매순 -->
		<if test="sortingType == 4">
			ORDER BY BAL.TOTAL_SALE_COUNT DESC
		</if>
	</select>
	
	<!-- 판매 정산 리스트 -->
	<select id="saleList" parameterType="com.bsg.pcms.balance.dto.BalanceDTOEx" 
						resultType="com.bsg.pcms.balance.dto.BalanceDTOEx">
		SELECT /* Balance.saleList */ 
			BAL.*, COM.COMPANY_NAME, CON.CONTRACT_TYPE,
			CONCAT(CONT.NAME, ' 외 ', count(CONT.NAME)-1) AS contents_name,				
			CDT.SALE_TYPE
			FROM BALANCE BAL, COMPANY COM, CONTRACT CON, CONTRACT_DETAIL CDT, BALANCE_DETAIL BD,
			CONTENTS CONT
		WHERE 1=1
		AND COM.COMPANY_MGMTNO = BAL.COMPANY_MGMTNO 
		AND BAL.CONTRACT_MGMTNO = CON.CONTRACT_MGMTNO
		AND BAL.BALANCE_MGMTNO = BD.BALANCE_MGMTNO 
		AND CON.CONTRACT_MGMTNO = CDT.CONTRACT_MGMTNO 
		AND CONT.CONTENTS_CD = BD.CONTENTS_CD
		AND BAL.DEL_YN = 'N'
		AND COM.COMPANY_TYPE = 'SC'
		AND BAL.REG_DT
			BETWEEN TIMESTAMP(CONCAT( DATE_FORMAT(NOW(), '%Y'), DATE_FORMAT(NOW(), '%m'), '01'))  
		AND TIMESTAMP(DATE_FORMAT(LAST_DAY((NOW())), '%Y-%m-%d 23:59:59'))
		GROUP BY BAL.CONTRACT_MGMTNO
		<!-- 등록순 -->
		<if test="sortingType == 1">
			ORDER BY BAL.BALANCE_MGMTNO 
		</if>
		<!-- 매출순 -->
		<if test="sortingType == 2">
			ORDER BY BAL.TOTAL_SALE_PRICE DESC
		</if>
		<!-- 수익순 -->
		<if test="sortingType == 3">
			ORDER BY BAL.OWNER_PROFIT DESC
		</if>
		<!-- 판매순 -->
		<if test="sortingType == 4">
			ORDER BY BAL.TOTAL_SALE_COUNT DESC
		</if>
			
	</select>
	
	<!-- 판매정산 조회 -->
	<select id="searchSale" resultType="com.bsg.pcms.balance.dto.BalanceDTOEx">
		SELECT /* Balance.searchByDate */ 
			BAL.*, COM.COMPANY_NAME, CON.CONTRACT_TYPE,
			CONCAT(CONT.NAME, ' 외 ', count(CONT.NAME)-1) AS contents_name,				
			CDT.SALE_TYPE
			FROM BALANCE BAL, COMPANY COM, CONTRACT CON, CONTRACT_DETAIL CDT, BALANCE_DETAIL BD,
			CONTENTS CONT
		WHERE 1=1
		AND COM.COMPANY_MGMTNO = BAL.COMPANY_MGMTNO 
		AND BAL.CONTRACT_MGMTNO = CON.CONTRACT_MGMTNO
		AND BAL.BALANCE_MGMTNO = BD.BALANCE_MGMTNO 
		AND CON.CONTRACT_MGMTNO = CDT.CONTRACT_MGMTNO 
		AND CONT.CONTENTS_CD = BD.CONTENTS_CD
		AND BAL.DEL_YN = 'N'
		AND COM.COMPANY_TYPE = 'SC'
		<if test="searchQuery != null">
		AND COM.COMPANY_NAME like '%${searchQuery}%'
		</if>
		<if test="searchStrDate != null">
			<if test="searchEndDate != null">
			AND BAL.REG_DT 
				BETWEEN #{searchStrDate}  
				AND #{searchEndDate}
			</if>
		</if>
		<!-- 등록순 -->
		<if test="sortingType == 1">
			ORDER BY BAL.BALANCE_MGMTNO 
		</if>
		<!-- 매출순 -->
		<if test="sortingType == 2">
			ORDER BY BAL.TOTAL_SALE_PRICE DESC
		</if>
		<!-- 수익순 -->
		<if test="sortingType == 3">
			ORDER BY BAL.OWNER_PROFIT DESC
		</if>
		<!-- 판매순 -->
		<if test="sortingType == 4">
			ORDER BY BAL.TOTAL_SALE_COUNT DESC
		</if>
	</select>
	
	
	<!-- 판매업체 리스티 -->
	<select id="saleCompanyList" resultType="java.util.Map">
		SELECT /* Balance.saleCompanyList */ 
			COM.COMPANY_NAME as company_name,
			COM.COMPANY_MGMTNO as company_mgmtno
		FROM COMPANY COM, CONTRACT CONT
		WHERE 1=1
		AND COM.COMPANY_MGMTNO = CONT.COMPANY_MGMTNO
		AND COM.COMPANY_TYPE = 'SC'
	</select>
	
	<!-- 판매업체 판매 디바이스 -->
	<select id="device" resultType="java.util.Map">
		SELECT /* Balance.device */ 
			CTD.SALE_TYPE as sale_type
		FROM COMPANY COM, CONTRACT CONT, CONTRACT_DETAIL CTD
		WHERE 1=1
		AND COM.COMPANY_MGMTNO = CONT.COMPANY_MGMTNO
		AND CONT.CONTRACT_MGMTNO = CTD.CONTRACT_MGMTNO
		AND COM.COMPANY_TYPE = 'SC'
		AND COM.COMPANY_MGMTNO = #{company_mgmtno}
		GROUP BY CTD.SALE_TYPE
	</select>
	
	<!-- 판매방식 -->
	<select id="saleType" resultType="java.util.Map">
		SELECT /* Balance.saleType */ 
			CONT.CONTRACT_TYPE as contract_type
		FROM COMPANY COM, CONTRACT CONT
		WHERE 1=1
		AND COM.COMPANY_MGMTNO = CONT.COMPANY_MGMTNO
		AND COM.COMPANY_TYPE = 'SC'
		AND COM.COMPANY_MGMTNO = #{company_mgmtno}
		GROUP BY CONT.CONTRACT_TYPE
	</select>
	
	<!-- 정산 대상 컨텐츠 리스트 -->
	<select id="contents" resultType="Map">
		SELECT 
			CCGR.CONTENTS_CD, 
			CON.NAME, 
			CCGR.SALE_PRICE, 
			(
				SELECT SALE_PROFIT_RATE FROM CONTRACT
				WHERE COMPANY_MGMTNO=CON.COMPANY_MGMTNO
				LIMIT 1
			) AS CP_RATE,
			CNTR.SALE_PROFIT_RATE AS SALE_COMPANY_RATE	
		
		FROM 
					COMPANY COM, CONTRACT CNTR, CONTENTS CON, CONTRACT_DETAIL CNTRD,
				 	CONTRACT_CONTENTS_GROUP CCGR
		WHERE 1=1 
		AND COM.COMPANY_MGMTNO = CNTR.COMPANY_MGMTNO 
		AND CNTRD.CONTRACT_MGMTNO = CNTR.CONTRACT_MGMTNO 
		AND CCGR.CONTRACT_MGMTNO = CNTRD.CONTRACT_MGMTNO 
		AND CON.CONTENTS_CD =CCGR.CONTENTS_CD 
		AND CNTR.COMPANY_MGMTNO = #{company_mgmtno}
		AND CNTRD.SALE_TYPE = #{sale_type}
		AND CNTR.CONTRACT_TYPE = #{contract_type}
		
	</select>
	
	<!-- 
	<select id="detail" resultType="java.lanMap">
		SELECT BAL.*, COM.COMPANY_NAME FROM BALANCE BAL, COMPANY COM
		WHERE 1=1
		AND COM.COMPANY_MGMTNO = BAL.COMPANY_MGMTNO 
		AND BAL.BALANCE_MGMTNO =  #{balance_mgmtno} 
		AND BAL.DEL_YN = 'N'
	</select>
	 -->
   <!-- UPDATE -->
   
   <update id="modify">
		UPDATE BALANCE 
		SET
			SALE_STR_DATE = #{sale_str_date}, 
			SALE_END_DATE= #{sale_end_date}, 
			SALE_COMMISSION= #{sale_commission}, 
			CP_COMMISSION= #{cp_commission}, 
			OWNER_PROFIT= #{owner_profit}, 
			TOTAL_SALE_COUNT= #{total_sale_count}, 
			TOTAL_SALE_PRICE= #{total_sale_price}, 
			MOD_DT= NOW()
		WHERE BALANCE_MGMTNO = #{balance_mgmtno}
   </update>
   
   <update id="delete">
		UPDATE BALANCE 
		SET
			DEL_YN = 'Y', 
			MOD_DT= NOW()
		WHERE BALANCE_MGMTNO = #{balance_mgmtno}
   </update>

   <!-- DELETE -->
   
</mapper>
